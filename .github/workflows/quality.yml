name: Quality Checks

on:
  push:
    branches:
      - main
      - develop
      - "feat/**"
      - "feature/**"
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

concurrency:
  # PRã¨pushã§ç•°ãªã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’é˜²æ­¢
  group: quality-${{ github.event_name }}-${{ github.event_name == 'pull_request' && github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      docs-only: ${{ steps.changes.outputs.docs-only }}
      markdown-changed: ${{ steps.changes.outputs.markdown-changed }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect file changes
        id: changes
        run: |
          set -euo pipefail

          # PRã®å ´åˆã¯ base ã¨ã®å·®åˆ†ã‚’å–å¾—ã€pushã®å ´åˆã¯GitHubã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½¿ç”¨
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            base_ref="${{ github.event.pull_request.base.sha }}"

            # ãƒ•ã‚©ãƒ¼ã‚¯PRã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
            if ! git rev-parse --verify "$base_ref" >/dev/null 2>&1; then
              echo "Base SHA not accessible, trying base branch: ${{ github.event.pull_request.base.ref }}"
              base_ref="origin/${{ github.event.pull_request.base.ref }}"

              # ãã‚Œã§ã‚‚ãƒ€ãƒ¡ãªå ´åˆã¯æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
              if ! git rev-parse --verify "$base_ref" >/dev/null 2>&1; then
                echo "Base branch not accessible, using HEAD~1 as fallback"
                base_ref="HEAD~1"
              fi
            fi

            changed_files=$(git diff --name-only $base_ref..HEAD)
          else
            # pushã®å ´åˆã¯GitHubã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½¿ç”¨
            before_sha="${{ github.event.before }}"
            current_sha="${{ github.sha }}"

            if [ -z "$before_sha" ] || [ "$before_sha" = "0000000000000000000000000000000000000000" ]; then
              # åˆå›žã‚³ãƒŸãƒƒãƒˆã¾ãŸã¯ç©ºã®å ´åˆã¯å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¯¾è±¡
              echo "Initial commit or empty before SHA detected, listing all files"
              changed_files=$(git ls-tree -r --name-only $current_sha)
            else
              # é€šå¸¸ã®pushã®å ´åˆ
              echo "Using GitHub context: $before_sha..$current_sha"
              changed_files=$(git diff --name-only $before_sha..$current_sha)
            fi
          fi

          echo "Changed files:"
          echo "$changed_files"

          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†é¡ž
          markdown_files=$(echo "$changed_files" | grep -E '\.md$' || true)
          code_files=$(echo "$changed_files" | grep -vE '\.md$|^docs/' || true)

          echo "Markdown files: $markdown_files"
          echo "Code files: $code_files"

          # Markdownãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [[ -n "$markdown_files" ]]; then
            echo "markdown-changed=true" >> $GITHUB_OUTPUT
            echo "Markdown files have been changed"
          else
            echo "markdown-changed=false" >> $GITHUB_OUTPUT
            echo "No markdown files changed"
          fi

          # docs-onlyã®åˆ¤å®šï¼ˆMarkdownãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã®å¤‰æ›´ï¼‰
          if [[ -n "$changed_files" && -z "$code_files" ]]; then
            echo "docs-only=true" >> $GITHUB_OUTPUT
            echo "This is a docs-only change"
          else
            echo "docs-only=false" >> $GITHUB_OUTPUT
            echo "This includes code changes"
          fi

  docs-quality:
    name: Documentation Quality
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs['markdown-changed'] == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Setup mise
        uses: jdx/mise-action@v2
        with:
          install: true
          cache: true

      - name: Check documentation quality
        run: |
          echo "## ðŸ“ Documentation Quality Check" >> $GITHUB_STEP_SUMMARY
          if mise run docs:check; then
            echo "âœ… Markdown lint and links check passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Some checks failed (non-blocking)" >> $GITHUB_STEP_SUMMARY
            # Link checkã¯è­¦å‘Šã®ã¿ï¼ˆå¤±æ•—ã•ã›ãªã„ï¼‰
          fi

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs['docs-only'] == 'false'
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10.19.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Restore ESLint cache
        uses: actions/cache@v4
        with:
          path: .eslintcache
          key: eslint-${{ runner.os }}-${{ hashFiles('eslint.config.js', 'package.json') }}
          restore-keys: |
            eslint-${{ runner.os }}-

      - name: Restore TypeScript cache
        uses: actions/cache@v4
        with:
          path: .tsbuildinfo
          key: tsbuildinfo-${{ runner.os }}-${{ hashFiles('tsconfig.json') }}
          restore-keys: |
            tsbuildinfo-${{ runner.os }}-

      - name: Restore Vitest cache
        uses: actions/cache@v4
        with:
          path: node_modules/.vitest
          key: vitest-${{ runner.os }}-${{ hashFiles('vitest.config.ts') }}
          restore-keys: |
            vitest-${{ runner.os }}-

      - name: Run linting
        run: |
          echo "## ðŸ” Code Linting" >> $GITHUB_STEP_SUMMARY
          if pnpm lint; then
            echo "âœ… Linting passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Linting failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Run type checking
        run: |
          echo "## ðŸ“‹ Type Checking" >> $GITHUB_STEP_SUMMARY
          if pnpm type-check; then
            echo "âœ… Type check passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Type check failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Run tests
        run: |
          echo "## ðŸ§ª Tests" >> $GITHUB_STEP_SUMMARY
          if pnpm test; then
            echo "âœ… All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Build action
        run: |
          echo "## ðŸ“¦ Build" >> $GITHUB_STEP_SUMMARY
          if pnpm build; then
            echo "âœ… Build passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Build failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Commit dist if changed
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if [[ -n "$(git status --porcelain dist/)" ]]; then
            git add dist/
            git commit -m "chore: update dist [skip ci]"

            # Retry push up to 3 times to handle race conditions
            for attempt in 1 2 3; do
              if git push; then
                echo "âœ… dist/ committed and pushed" >> $GITHUB_STEP_SUMMARY
                exit 0
              elif [[ $attempt -lt 3 ]]; then
                echo "Push attempt $attempt failed, retrying after delay..."
                sleep $((attempt * 2))
              else
                echo "âŒ Failed to push dist/ after 3 attempts" >> $GITHUB_STEP_SUMMARY
                exit 1
              fi
            done
          else
            echo "â„¹ï¸ No changes to dist/" >> $GITHUB_STEP_SUMMARY
          fi

  integration-test:
    name: Integration Tests (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs['docs-only'] == 'false'
    strategy:
      fail-fast: false
      matrix:
        node-version: [20, 22]

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10.19.0

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Restore TypeScript cache
        uses: actions/cache@v4
        with:
          path: .tsbuildinfo
          key: tsbuildinfo-${{ runner.os }}-${{ hashFiles('tsconfig.json') }}
          restore-keys: |
            tsbuildinfo-${{ runner.os }}-

      - name: Restore Vitest cache
        uses: actions/cache@v4
        with:
          path: node_modules/.vitest
          key: vitest-${{ runner.os }}-${{ hashFiles('vitest.config.ts') }}
          restore-keys: |
            vitest-${{ runner.os }}-

      - name: Run integration tests
        run: |
          echo "## ðŸ”¬ Integration Tests (Node ${{ matrix.node-version }})" >> $GITHUB_STEP_SUMMARY
          if pnpm test:vitest __tests__/integration.test.ts; then
            echo "âœ… Integration tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Integration tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Verify dist/ build
        run: |
          echo "## ðŸ“¦ Verify dist/ Build" >> $GITHUB_STEP_SUMMARY

          # æ—¢å­˜ã®dist/ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
          cp -r dist/ dist-backup/

          # å†ãƒ“ãƒ«ãƒ‰
          pnpm build

          # å·®åˆ†ãƒã‚§ãƒƒã‚¯ï¼ˆç’°å¢ƒä¾å­˜ã®ç”Ÿæˆç‰©ã¯é™¤å¤–ï¼‰
          # - *.map: ã‚½ãƒ¼ã‚¹ãƒžãƒƒãƒ—ã¯ç’°å¢ƒã«ã‚ˆã‚Šãƒ‘ã‚¹ãŒå¤‰ã‚ã‚‹ã“ã¨ãŒã‚ã‚‹
          # - *.d.ts, *.d.ts.map: åž‹å®šç¾©ã¨ãã®ãƒžãƒƒãƒ—ã‚‚ç’°å¢ƒä¾å­˜ã®å·®åˆ†ãŒå‡ºã‚„ã™ã„
          if diff -r \
            -x "*.map" \
            -x "*.d.ts" \
            -x "*.d.ts.map" \
            dist/ dist-backup/ > /dev/null 2>&1; then
            echo "âœ… dist/ is up to date" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ dist/ differs from committed version" >> $GITHUB_STEP_SUMMARY
            echo "Run \`pnpm build\` and commit the changes" >> $GITHUB_STEP_SUMMARY
            echo "(non-deterministic files are excluded: *.map, *.d.ts, *.d.ts.map)" >> $GITHUB_STEP_SUMMARY
            diff -r -x "*.map" -x "*.d.ts" -x "*.d.ts.map" dist/ dist-backup/ || true
            exit 1
          fi

  self-check:
    name: PR Labeler Self-Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
      issues: write
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run PR Labeler (self-check)
        uses: jey3dayo/pr-labeler@main
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          file_size_limit: "100KB"
          file_lines_limit: "500"
          pr_additions_limit: "5000"
          pr_files_limit: "50"
          comment_on_pr: "auto"
          apply_labels: "true"
          enable_summary: "true"
          # Workflow failure control (disabled for self-check)
          fail_on_large_files: ""
          fail_on_too_many_files: ""
          fail_on_pr_size: ""
          additional_exclude_patterns: |
            src/index.ts

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [detect-changes, docs-quality, code-quality, integration-test, self-check]
    if: always()

    steps:
      - name: Determine overall result
        run: |
          docs_only="${{ needs.detect-changes.outputs['docs-only'] }}"
          markdown_changed="${{ needs.detect-changes.outputs['markdown-changed'] }}"
          docs_result="${{ needs.docs-quality.result }}"
          code_result="${{ needs.code-quality.result }}"
          integration_result="${{ needs.integration-test.result }}"
          self_check_result="${{ needs.self-check.result }}"

          echo "## ðŸŽ¯ Quality Gate Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "$docs_only" == "true" ]]; then
            # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã¿ã®å¤‰æ›´
            echo "ðŸ“ **Documentation-only PR detected**" >> $GITHUB_STEP_SUMMARY

            if [[ "$docs_result" == "success" ]] || [[ "$docs_result" == "skipped" ]]; then
              echo "âœ… Documentation quality checks passed" >> $GITHUB_STEP_SUMMARY
              echo "result=success" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "âŒ Documentation quality checks failed" >> $GITHUB_STEP_SUMMARY
              echo "result=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            # ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’å«ã‚€
            echo "ðŸ’» **Code changes detected**" >> $GITHUB_STEP_SUMMARY

            all_success=true

            # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯çµæžœ
            if [[ "$code_result" == "success" ]]; then
              echo "âœ… Code quality checks passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Code quality checks failed" >> $GITHUB_STEP_SUMMARY
              all_success=false
            fi

            # çµ±åˆãƒ†ã‚¹ãƒˆçµæžœ
            if [[ "$integration_result" == "success" ]]; then
              echo "âœ… Integration tests passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Integration tests failed" >> $GITHUB_STEP_SUMMARY
              all_success=false
            fi

            # è‡ªå·±ãƒã‚§ãƒƒã‚¯çµæžœï¼ˆPRæ™‚ã®ã¿ï¼‰
            if [[ "$self_check_result" == "success" ]]; then
              echo "âœ… PR Labeler self-check passed" >> $GITHUB_STEP_SUMMARY
            elif [[ "$self_check_result" == "failure" ]]; then
              echo "âŒ PR Labeler self-check failed" >> $GITHUB_STEP_SUMMARY
              all_success=false
            fi

            # Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å¤‰æ›´ã•ã‚Œã¦ã„ã‚‹å ´åˆ
            if [[ "$markdown_changed" == "true" ]]; then
              if [[ "$docs_result" == "success" ]]; then
                echo "âœ… Documentation quality checks passed" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ Documentation quality checks failed" >> $GITHUB_STEP_SUMMARY
                all_success=false
              fi
            fi

            if [[ "$all_success" == "true" ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "## âœ… All quality checks passed!" >> $GITHUB_STEP_SUMMARY
              echo "result=success" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "## âŒ Some quality checks failed" >> $GITHUB_STEP_SUMMARY
              echo "result=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi
