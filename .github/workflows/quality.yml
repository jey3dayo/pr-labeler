name: Quality Checks

on:
  push:
    branches:
      - main
      - develop
      - "feat/**"
      - "feature/**"
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

concurrency:
  # PRã¨pushã§ç•°ãªã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’é˜²æ­¢
  group: quality-${{ github.event_name }}-${{ github.event_name == 'pull_request' && github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      docs-only: ${{ steps.changes.outputs.docs-only }}
      markdown-changed: ${{ steps.changes.outputs.markdown-changed }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect file changes
        id: changes
        run: |
          set -euo pipefail

          # PRã®å ´åˆã¯ base ã¨ã®å·®åˆ†ã‚’å–å¾—ã€pushã®å ´åˆã¯GitHubã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½¿ç”¨
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            base_ref="${{ github.event.pull_request.base.sha }}"

            # ãƒ•ã‚©ãƒ¼ã‚¯PRã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
            if ! git rev-parse --verify "$base_ref" >/dev/null 2>&1; then
              echo "Base SHA not accessible, trying base branch: ${{ github.event.pull_request.base.ref }}"
              base_ref="origin/${{ github.event.pull_request.base.ref }}"

              # ãã‚Œã§ã‚‚ãƒ€ãƒ¡ãªå ´åˆã¯æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
              if ! git rev-parse --verify "$base_ref" >/dev/null 2>&1; then
                echo "Base branch not accessible, using HEAD~1 as fallback"
                base_ref="HEAD~1"
              fi
            fi

            changed_files=$(git diff --name-only $base_ref..HEAD)
          else
            # pushã®å ´åˆã¯GitHubã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½¿ç”¨
            before_sha="${{ github.event.before }}"
            current_sha="${{ github.sha }}"

            if [ -z "$before_sha" ] || [ "$before_sha" = "0000000000000000000000000000000000000000" ]; then
              # åˆå›žã‚³ãƒŸãƒƒãƒˆã¾ãŸã¯ç©ºã®å ´åˆã¯å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¯¾è±¡
              echo "Initial commit or empty before SHA detected, listing all files"
              changed_files=$(git ls-tree -r --name-only $current_sha)
            else
              # é€šå¸¸ã®pushã®å ´åˆ
              echo "Using GitHub context: $before_sha..$current_sha"
              changed_files=$(git diff --name-only $before_sha..$current_sha)
            fi
          fi

          echo "Changed files:"
          echo "$changed_files"

          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†é¡ž
          markdown_files=$(echo "$changed_files" | grep -E '\.md$' || true)
          code_files=$(echo "$changed_files" | grep -vE '\.md$|^docs/' || true)

          echo "Markdown files: $markdown_files"
          echo "Code files: $code_files"

          # Markdownãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [[ -n "$markdown_files" ]]; then
            echo "markdown-changed=true" >> $GITHUB_OUTPUT
            echo "Markdown files have been changed"
          else
            echo "markdown-changed=false" >> $GITHUB_OUTPUT
            echo "No markdown files changed"
          fi

          # docs-onlyã®åˆ¤å®šï¼ˆMarkdownãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã®å¤‰æ›´ï¼‰
          if [[ -n "$changed_files" && -z "$code_files" ]]; then
            echo "docs-only=true" >> $GITHUB_OUTPUT
            echo "This is a docs-only change"
          else
            echo "docs-only=false" >> $GITHUB_OUTPUT
            echo "This includes code changes"
          fi

  docs-quality:
    name: Documentation Quality
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs['markdown-changed'] == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Setup mise
        uses: jdx/mise-action@v2
        with:
          install: true
          cache: true

      - name: Run Markdown lint
        run: |
          echo "## ðŸ“ Markdown Lint Check" >> $GITHUB_STEP_SUMMARY
          if markdownlint-cli2 '**/*.md'; then
            echo "âœ… Markdown lint passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Markdown lint failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Check Markdown links
        run: |
          echo "## ðŸ”— Link Check" >> $GITHUB_STEP_SUMMARY
          if find . -name '*.md' -not -path './node_modules/*' -not -path './dist/*' -not -path './.git/*' -exec markdown-link-check --config .markdown-link-check.json --quiet {} \; ; then
            echo "âœ… All links are valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Some links may be broken (check logs for details)" >> $GITHUB_STEP_SUMMARY
            # Link checkã¯è­¦å‘Šã®ã¿ï¼ˆå¤±æ•—ã•ã›ãªã„ï¼‰
          fi

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs['docs-only'] == 'false'

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10.18.3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linting
        run: |
          echo "## ðŸ” Code Linting" >> $GITHUB_STEP_SUMMARY
          if pnpm lint; then
            echo "âœ… Linting passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Linting failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Run type checking
        run: |
          echo "## ðŸ“‹ Type Checking" >> $GITHUB_STEP_SUMMARY
          if pnpm type-check; then
            echo "âœ… Type check passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Type check failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Run tests
        run: |
          echo "## ðŸ§ª Tests" >> $GITHUB_STEP_SUMMARY
          if pnpm test; then
            echo "âœ… All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Build action
        run: |
          echo "## ðŸ“¦ Build" >> $GITHUB_STEP_SUMMARY
          if pnpm build; then
            echo "âœ… Build passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Build failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Commit dist if changed
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if [[ -n "$(git status --porcelain dist/)" ]]; then
            git add dist/
            git commit -m "chore: update dist [skip ci]"
            git push
            echo "âœ… dist/ committed and pushed" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No changes to dist/" >> $GITHUB_STEP_SUMMARY
          fi

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [detect-changes, docs-quality, code-quality]
    if: always()

    steps:
      - name: Determine overall result
        run: |
          docs_only="${{ needs.detect-changes.outputs['docs-only'] }}"
          markdown_changed="${{ needs.detect-changes.outputs['markdown-changed'] }}"
          docs_result="${{ needs.docs-quality.result }}"
          code_result="${{ needs.code-quality.result }}"

          echo "## ðŸŽ¯ Quality Gate Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "$docs_only" == "true" ]]; then
            # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã¿ã®å¤‰æ›´
            echo "ðŸ“ **Documentation-only PR detected**" >> $GITHUB_STEP_SUMMARY

            if [[ "$docs_result" == "success" ]] || [[ "$docs_result" == "skipped" ]]; then
              echo "âœ… Documentation quality checks passed" >> $GITHUB_STEP_SUMMARY
              echo "result=success" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "âŒ Documentation quality checks failed" >> $GITHUB_STEP_SUMMARY
              echo "result=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            # ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’å«ã‚€
            echo "ðŸ’» **Code changes detected**" >> $GITHUB_STEP_SUMMARY

            all_success=true

            # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯çµæžœ
            if [[ "$code_result" == "success" ]]; then
              echo "âœ… Code quality checks passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Code quality checks failed" >> $GITHUB_STEP_SUMMARY
              all_success=false
            fi

            # Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å¤‰æ›´ã•ã‚Œã¦ã„ã‚‹å ´åˆ
            if [[ "$markdown_changed" == "true" ]]; then
              if [[ "$docs_result" == "success" ]]; then
                echo "âœ… Documentation quality checks passed" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ Documentation quality checks failed" >> $GITHUB_STEP_SUMMARY
                all_success=false
              fi
            fi

            if [[ "$all_success" == "true" ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "## âœ… All quality checks passed!" >> $GITHUB_STEP_SUMMARY
              echo "result=success" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "## âŒ Some quality checks failed" >> $GITHUB_STEP_SUMMARY
              echo "result=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi
