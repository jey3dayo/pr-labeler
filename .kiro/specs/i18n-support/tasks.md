# Implementation Plan: i18n Support

本実装計画は、PR Labelerに多言語対応（i18n）機能を追加し、GitHub Actions Summary、エラーメッセージ、ログメッセージ、PRコメントを英語と日本語で提供するものです。

## Phase 1: 基盤構築とSummary多言語化

- [x] 1. i18n基盤の構築
- [x] 1.1 i18nextライブラリの統合と初期化システムの構築
  - i18next依存関係をpackage.jsonに追加（v23.x以上）
  - 言語決定ロジックの実装（優先順位: LANGUAGE環境変数 > LANG環境変数 > pr-labeler.yml設定 > デフォルト英語）
    - **重要**: `LANGUAGE` と `LANG` の両方の環境変数をサポート
    - `LANGUAGE` が優先、`LANGUAGE` が未設定の場合は `LANG` を確認
  - 言語コード正規化機能の実装（ja-JP → ja、en-US → en）
  - i18next初期化関数の実装（静的importでリソース読み込み、同期初期化）
  - 英語フォールバック戦略の実装
  - _Requirements: 1.1, 1.2, 1.3, 1.5, 1.6_

- [x] 1.2 型安全な翻訳システムの構築
  - 型生成スクリプトの実装（翻訳JSONから型定義を自動生成）
  - **段階的導入方針**: Phase 1はresources形状型のみ実装（リスク低減）
    - TranslationResources型の生成（typeof enSummary等）
    - i18next型拡張（CustomTypeOptionsでresourcesを定義）
    - エディタ補完とコンパイル時検証の動作確認
  - **Phase 2以降**: DotPath型ユーティリティ実装（キーunion生成）
    - `DotPath<T>`型の実装（ネストオブジェクト→ドット区切りキー）
    - TranslationKey型の生成（全キーのunion）
  - ビルドプロセスへの型生成統合（pnpm build、pnpm dev）
  - _Requirements: 5.1, 5.2, 5.3, 5.9_

- [x] 1.3 翻訳リソースの基本構造作成
  - locales/en/ディレクトリ構造の作成（5名前空間）
  - locales/ja/ディレクトリ構造の作成（5名前空間）
  - summary名前空間の英語翻訳リソース作成
  - summary名前空間の日本語翻訳リソース作成
  - _Requirements: 1.7, 1.8, 1.9_

- [x] 2. GitHub Actions Summaryの多言語化
- [x] 2.1 数値とファイルサイズのフォーマット機能の実装
  - 数値フォーマット関数の実装（Intl.NumberFormatを使用）
  - ファイルサイズフォーマット関数の実装（1024基数、B/KB/MB/GB）
  - ロケール対応の実装（英語・日本語）
  - 半角スペース仕様の実装（例: "100 KB"）
  - _Requirements: 2.6, 2.7_

- [x] 2.2 Summary出力の翻訳統合
  - 基本メトリクスセクションの翻訳適用
  - 違反情報セクションの翻訳適用
  - 複雑度サマリセクションの翻訳適用
  - 推奨事項セクションの翻訳適用
  - 文単位でのキー化と変数補間の実装
  - _Requirements: 2.1, 2.5_

- [x] 3. i18n基盤のテストと品質保証
- [x] 3.1 翻訳キー整合性テストの実装
  - 全言語での翻訳キー完備性チェック機能
  - 欠落キー検出と明確なエラーメッセージ
  - 孤立キー（英語にないキー）の検出
  - CI統合とテスト自動実行
  - _Requirements: 5.5, 5.6_

- [x] 3.2 コア機能の単体テスト実装
  - 言語決定ロジックのテスト（優先順位、正規化）
    - LANGUAGE環境変数が優先されることの確認
    - LANGUAGE未設定時にLANG環境変数が使用されることの確認
  - i18n初期化のテスト（正常系、エラーハンドリング）
  - 翻訳関数のテスト（キー解決、補間、フォールバック）
  - 数値・サイズフォーマットのテスト（ロケール別）
  - **技術詳細保持のテスト**（受入基準2.8対応）:
    - エラーメッセージ内のファイル名が翻訳されずに保持されることの確認
    - ログメッセージ内のパスが原形のまま出力されることの確認
    - エラーコード、行番号等の技術情報が変更されないことの検証
  - _Requirements: 1.3, 1.4, 1.5, 2.6, 2.7, 2.8_

- [x] 3.3 Summary出力のスナップショットテスト実装
  - 英語環境でのSummary出力スナップショット
  - 日本語環境でのSummary出力スナップショット
  - 回帰検出の自動化
  - _Requirements: 2.1, 4.1, 4.2_

## Phase 2: 全出力の多言語化

- [ ] 4. エラーメッセージの多言語化
- [x] 4.1 エラー翻訳リソースの作成
  - errors名前空間の英語翻訳リソース作成
  - errors名前空間の日本語翻訳リソース作成
  - エラータイプ別のキー整理（Configuration/GitHub/FileSystem等）
  - 技術詳細の保持戦略（ファイル名、パス、エラーコード）
  - _Requirements: 2.4, 2.8_

- [x] 4.2 エラーファクトリーへの翻訳統合
  - エラー生成時の翻訳キー適用
  - エラーメッセージの補間変数対応
  - 技術詳細と翻訳メッセージの組み合わせ
  - 既存エラーハンドリングの後方互換性保証
  - _Requirements: 2.4, 4.1, 4.2_

- [x] 5. ログメッセージの多言語化
- [x] 5.1 ログ翻訳リソースの作成
  - logs名前空間の英語翻訳リソース作成
  - logs名前空間の日本語翻訳リソース作成
  - ログカテゴリ別のキー整理（初期化/分析/完了）
  - _Requirements: 2.3_

- [x] 5.2 ログ出力への翻訳統合
  - 情報ログの翻訳適用
  - 警告ログの翻訳適用
  - エラーログの翻訳適用
  - フォールバック監査ログの実装（初回warning、2回目以降debug）
  - _Requirements: 2.3_

- [ ] 6. PRコメントとラベル説明の多言語化
- [x] 6.1 ラベルと共通翻訳リソースの作成
  - labels名前空間の英語翻訳リソース作成
  - labels名前空間の日本語翻訳リソース作成
  - common名前空間の英語翻訳リソース作成（共通メッセージ、単位等）
  - common名前空間の日本語翻訳リソース作成
  - _Requirements: 2.5_

- [x] 6.2 PRコメント生成への翻訳統合
  - コメント本文テンプレートの翻訳適用（ヘッダー、フッター）
  - エラーセクションの翻訳適用
  - 文単位でのキー化と適切な粒度の実装
  - 日本語/英語環境でのテストケース追加
  - 型生成スクリプトの更新（common/labels名前空間の追加）
  - _Requirements: 2.2_

- [ ] 7. 統合テストとスナップショット整備
- [x] 7.1 言語別スナップショットテストの実装
  - PRコメント出力のスナップショット（英語・日本語） - comment-manager.test.ts
  - エラーメッセージのスナップショット（英語・日本語） - error-factories-i18n.test.ts
  - ログメッセージのスナップショット（英語・日本語） - actions-io.test.ts
  - Summary/Violations/Complexity等のスナップショット - report-formatter.test.ts
  - _Requirements: 2.2, 2.3, 2.4_

- [x] 7.2 フォールバック動作のテスト実装
  - 翻訳キー欠落時の英語フォールバックテスト - i18n.test.ts
  - 不正言語コード時のフォールバックテスト - i18n.test.ts (normalizeLanguageCode)
  - 翻訳キー整合性テスト拡張（全5名前空間対応） - i18n-integrity.test.ts
  - Cross-namespace検証追加
  - _Requirements: 1.4, 1.5, 1.6_

- [x] 7.3 エンドツーエンド統合テストの実装
  - 環境変数指定時の全出力多言語化テスト - integration.test.ts（既存）
  - 設定ファイル指定時の全出力多言語化テスト - i18n.test.ts (determineLanguage)
  - 言語未指定時の英語出力テスト - i18n.test.ts (default to 'en')
  - 既存英語環境での回帰テスト（後方互換性） - 全テストスイート（562テスト）
  - _Requirements: 1.3, 1.4, 4.1, 4.2, 4.3_

## Phase 3: 設定ファイル多言語対応

- [ ] 8. 設定スキーマの拡張
- [ ] 8.1 設定型定義の拡張
  - PRLabelerConfig型にlanguageフィールド追加
  - LabelConfig型にdisplay_nameフィールド追加（多言語対応）
  - display_nameのスキーマ定義（en/ja構造）
  - 型定義のバリデーション
  - _Requirements: 3.1, 3.2_

- [ ] 8.2 設定ローダーの多言語対応
  - language設定フィールドの読み込み機能
  - display_name設定フィールドの読み込み機能
  - 選択言語に応じたdisplay_name取得ロジック
  - 英語フォールバックの実装（display_name未定義時）
  - 既存name設定の後方互換性保証
  - _Requirements: 3.3, 3.4, 3.5, 4.5_

- [ ] 8.3 ラベル表示名の多言語対応
  - ラベル判定エンジンでの表示名取得
  - Summary出力での多言語表示名の使用
  - PRコメントでの多言語表示名の使用
  - GitHub API呼び出しは英語name固定の維持
  - カスタム翻訳の上書きサポート
  - _Requirements: 3.4, 3.6, 3.7_

- [ ] 9. パフォーマンス最適化とビルド統合
- [ ] 9.1 パフォーマンステストと最適化
  - 初期化時間のパフォーマンステスト（100ms以内）
  - 翻訳ルックアップのパフォーマンステスト（1ms以内）
  - バンドルサイズの検証（50KB以内の増加）
  - メモリ使用量の確認
  - _Requirements: Non-functional (パフォーマンス)_

- [ ] 9.2 ビルドプロセスの統合
  - package.jsonスクリプトの更新（型生成の統合）
  - pnpm buildワークフローの確認（型生成 → TSコンパイル → nccバンドル）
  - pnpm devでの型生成watch mode
  - **nccバンドルでの翻訳JSON同梱の具体手順**:
    - 静的import方式の確認（`import json from './locales/en/summary.json'`）
    - FS読み込み（fs.readFileSync等）を使用していないことの確認
    - dist/index.jsに翻訳JSONが埋め込まれていることの検証
    - バンドルサイズの測定（翻訳リソース込みで50KB以内の増加）
  - _Requirements: 5.4, 5.8_

- [ ] 10. 品質保証と最終検証
- [ ] 10.1 テストカバレッジの検証
  - 全体カバレッジ90%以上の確認
  - i18n関連モジュール95%以上の確認
  - 翻訳キー整合性100%の確認
  - カバレッジレポートの確認
  - _Requirements: Testing Strategy全体_

- [ ] 10.2 統合テストスイートの実行
  - 全単体テストの実行と成功確認
  - 全統合テストの実行と成功確認
  - スナップショットテストの検証
  - フォールバックテストの検証
  - パフォーマンステストの検証
  - _Requirements: 全要件の検証_

- [ ] 10.3 既存機能の回帰テスト
  - 英語環境での既存テストスイート実行
  - 出力メッセージの内容確認（既存と同等）
  - ラベル適用動作の確認
  - PRコメント生成動作の確認
  - エラーハンドリング動作の確認
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [ ] 11. CI/CD統合と最終調整
- [ ] 11.1 CI/CDパイプラインの更新
  - GitHub Actions workflowに型生成ステップ追加
  - 翻訳キー整合性テストのCI統合
  - ビルド成功の確認
  - CI実行時間の確認（大幅増加がないこと）
  - _Requirements: 5.4, 5.6_

- [ ] 11.2 品質チェックの実行
  - pnpm lintの実行と成功確認
  - pnpm type-checkの実行と成功確認
  - pnpm testの実行と成功確認
  - pnpm buildの実行と成功確認
  - dist/サイズの検証（50KB以内の増加）
  - _Requirements: Non-functional (品質保証)_

- [ ] 11.3 ドキュメントと移行ガイドの作成
  - README.mdに多言語設定の使用方法を追加
    - `LANGUAGE`環境変数の説明と使用例
    - `pr-labeler.yml`の`language`フィールド説明
    - `display_name`設定例（英語・日本語サンプル）
  - 移行ガイドの作成（MIGRATION.md）
    - 英語のみ設定から多言語設定への移行手順
    - display_nameの追加方法
    - 後方互換性の説明
  - API.mdに多言語関連APIの説明追加
  - _Requirements: ドキュメント整備（実装完了後のユーザー対応）_

- [ ] 11.4 翻訳品質管理の整備
  - 用語集の作成（docs/i18n-glossary.md）
    - 訳語の統一ルール（例: size→サイズ、complexity→複雑度）
    - 技術用語の翻訳方針（例: PR→PR、label→ラベル）
    - カテゴリ名の扱い（英語固定）
  - 翻訳スタイルガイドの作成
    - 文体ルール（です・ます調 vs である調）
    - 表現ルール（簡潔性、分かりやすさ）
  - 翻訳レビュープロセスの文書化
    - レビュー観点（自然さ、用語統一、文脈適合）
    - レビュー担当者の役割
  - _Requirements: 翻訳品質の維持（メンテナンス性向上）_

- [ ] 11.5 フォールバック監査レポート機能の実装（オプション）
  - 欠落キー件数の収集機能実装
  - debugログでの集計出力
  - Summary末尾への簡易統計表示（設定で有効化: `show_missing_translations`）
  - 表示例: "Note: 3 translation keys fell back to English during this run"
  - _Requirements: 観測性向上（品質改善の基盤、任意）_

## Requirements Coverage Matrix

以下のマトリクスで全要件がタスクでカバーされていることを確認します。

| Requirement | Summary                      | Covered by Tasks |
| ----------- | ---------------------------- | ---------------- |
| 1.1         | i18next採用                  | 1.1              |
| 1.2         | 翻訳リソース読み込み         | 1.1, 1.3         |
| 1.3         | 言語決定優先順位             | 1.1, 7.3         |
| 1.4         | 英語フォールバック           | 1.1, 7.2         |
| 1.5         | 不正言語コードフォールバック | 1.1, 7.2         |
| 1.6         | リソース読み込み失敗時継続   | 1.1, 7.2         |
| 1.7         | ディレクトリ構成             | 1.3              |
| 1.8         | 名前空間整理                 | 1.3              |
| 1.9         | キー命名規則                 | 1.3              |
| 2.1         | Summary翻訳                  | 2.2              |
| 2.2         | PRコメント翻訳               | 6.2              |
| 2.3         | ログ翻訳                     | 5.1, 5.2         |
| 2.4         | エラーメッセージ翻訳         | 4.1, 4.2         |
| 2.5         | ラベル説明翻訳               | 6.1, 8.3         |
| 2.6         | 数値フォーマット             | 2.1              |
| 2.7         | ファイルサイズフォーマット   | 2.1              |
| 2.8         | 技術詳細の保持               | 4.1              |
| 3.1         | display_name設定サポート     | 8.1, 8.2         |
| 3.2         | GitHub実ラベル名英語固定     | 8.3              |
| 3.3         | 表示名の多言語化             | 8.3              |
| 3.4         | display_nameフォールバック   | 8.2              |
| 3.5         | display_name未定義時name使用 | 8.2              |
| 3.6         | カスタム翻訳マージ           | 8.3              |
| 3.7         | 後方互換性（設定）           | 8.2              |
| 4.1         | 既存設定での継続動作         | 10.3             |
| 4.2         | 英語デフォルト               | 10.3             |
| 4.3         | 英語文字列の扱い             | 10.3             |
| 4.4         | 新旧フォーマット共存         | 8.2, 10.3        |
| 4.5         | 英語のみ設定の互換性         | 8.2, 10.3        |
| 5.1         | 型安全な翻訳キー             | 1.2              |
| 5.2         | ビルド時型生成               | 1.2              |
| 5.3         | コンパイル時検証             | 1.2              |
| 5.4         | 一貫したファイル構造         | 1.3, 9.2         |
| 5.5         | CI翻訳キー検証               | 3.1              |
| 5.6         | 欠落キーでテスト失敗         | 3.1              |
| 5.7         | 翻訳キー欠落時の明確エラー   | 3.1              |
| 5.8         | 新言語追加の容易性           | 9.2              |
| 5.9         | エディタ補完                 | 1.2              |

**カバレッジ確認**: 全41受入基準がタスク1-11でカバーされています。

## Task Completion Checklist

各タスク完了時に以下を確認：

- [ ] 実装コードが型安全（`any`型なし、型アサーション最小限）
- [ ] 単体テストを実装し、テスト成功
- [ ] 翻訳キー整合性テスト成功（全言語でキー完備）
- [ ] pnpm lintエラーなし
- [ ] pnpm type-checkエラーなし
- [ ] 既存テストの回帰なし
- [ ] コミットメッセージがConventional Commits準拠

## Success Criteria

全タスク完了時に以下を達成：

- [ ] 英語・日本語でGitHub Actions Summaryが表示可能
- [ ] すべてのエラーメッセージが翻訳されている
- [ ] すべてのログメッセージが翻訳されている
- [ ] PRコメントが選択言語で生成される
- [ ] ラベル表示名が多言語対応
- [ ] 環境変数または設定ファイルで言語選択可能
- [ ] 既存の英語環境で動作に変更なし
- [ ] テストカバレッジ90%以上維持
- [ ] 翻訳キー整合性100%
- [ ] バンドルサイズ増加が50KB以内
- [ ] CI/CDパイプラインが成功

## Implementation Notes

### TDD Approach (推奨)

各タスクでTest-Driven Development（TDD）を採用することを推奨：

1. **Red**: テストを先に書く（失敗することを確認）
2. **Green**: 最小限の実装でテスト成功
3. **Refactor**: コード品質向上、リファクタリング

### Incremental Integration

- タスク1-3完了時点で、Summary多言語化が動作確認可能
- タスク4-7完了時点で、全出力の多言語化が完了
- タスク8完了時点で、設定ファイル多言語対応が完了
- タスク9-11で品質保証と最終調整

### Rollback Strategy

各Phase完了時に検証ポイントを設定：

- Phase 1: Summary多言語化のみ、既存動作保証
- Phase 2: 全出力多言語化、フォールバック検証
- Phase 3: 設定対応、後方互換性検証

問題発生時はPhase単位でロールバック可能。

---

**参照ドキュメント**:

- 要件定義: `.kiro/specs/i18n-support/requirements.md`
- 技術設計: `.kiro/specs/i18n-support/design.md`
- ステアリング: `.kiro/steering/*.md`
