# 実装計画: PR Labeler

## 概要

本ドキュメントは、PRメトリクス分析に基づく自動ラベル付けアクションの実装タスクを定義します。既存のpr-metrics-actionのコアロジックを再利用し、サイズ、複雑度、リスク、カテゴリの4つのディメンションでPRを自動的に分類します。

## 実装タスク

- [x] 1. プロジェクト基盤と依存関係のセットアップ
- [x] 1.1 新規ライブラリの追加とプロジェクト設定の更新
  - ESLint標準complexityルール（循環的複雑度計算）とjs-yaml（YAML設定パース）を依存関係に追加
  - TypeScript設定、ESLint設定、Vitest設定が新規ライブラリと互換性があることを確認
  - 型定義パッケージ（@types/js-yaml）を開発依存関係に追加
  - package.jsonのスクリプトを確認し、必要に応じて更新
  - _要件: 7.1, 7.2, 7.3（既存技術スタックとの整合性）_

- [ ] 1.3 複雑度ライブラリのPoCと互換性検証
  - ESLint複雑度分析のPoC実装（.ts/.tsxのAST解析、関数単位の複雑度取得）
  - 大規模ファイル（>10,000行）とOS差異の動作確認（GitHub Actions/ローカル）
  - 互換性/パフォーマンスに問題がある場合のフォールバック（`complexity.enabled=false`）の確認
  - 既知制約・既知不具合の整理と設計ドキュメント反映
  - _要件: 2.4, 2.5, 9.5（複雑度計算の安定性と運用）_

- [x] 1.2 デフォルト設定とエラー型定義の準備
  - ラベリング設定のデフォルト値を定義（サイズ閾値、複雑度閾値、カテゴリパターン、リスクルール）
  - エラー型階層を定義（ConfigurationError、GitHubAPIError、ComplexityAnalysisError、FileSystemError）
  - 各エラー型のインターフェースとファクトリ関数を実装
  - neverthrowのResult型と統合するエラーハンドリングユーティリティを作成
  - _要件: 6.2, 7.4（型安全なエラーハンドリング）_

- [x] 2. YAML設定管理システムの実装
- [x] 2.1 設定ファイルの読み込みとパース機能
  - GitHub APIまたはローカルファイルシステムから`.github/pr-labeler.yml`を読み込む
  - js-yamlのJSON Schemaモードでパースし、危険なYAML構文を無効化
  - ファイルが存在しない場合（404エラー）はデフォルト設定を返す
  - YAML構文エラー時はエラーメッセージを生成し、デフォルト設定にフォールバック
  - _要件: 5.1, 5.2（設定ファイルの読み込み）_

- [x] 2.2 設定値のバリデーションとサニタイゼーション
  - パースされた設定値の型検証を実装（TypeScript型定義との整合性）
  - サイズ閾値の整合性チェック（small < medium < large < xlarge）
  - 複雑度閾値の範囲検証（非負整数、妥当な範囲内）
  - カテゴリパターンのminimatch構文検証
  - 無効な設定値に対するバリデーションエラーの生成
  - _要件: 5.3, 5.4, 5.7, 5.8（設定バリデーション）_

- [x] 2.3 設定のマージとデフォルト値の適用
  - ユーザー設定とデフォルト設定を安全にマージ
  - 部分的な設定（一部のフィールドのみ指定）を適切に処理
  - 未知キーに対する警告ログの出力（厳格エラーにはしない）
  - 最終的な設定オブジェクトをResult型で返す
  - _要件: 5.6（カスタマイズされた設定の適用）_

- [ ] 3. 循環的複雑度分析機能の実装
- [ ] 3.1 ESLint標準complexityルールとの統合と基本的な複雑度計算
  - ESLint標準complexityルールを使用してTypeScript/JavaScriptファイルの複雑度を計算
  - 対象拡張子（.ts, .tsx）のフィルタリング機能
  - 単一ファイルの複雑度計算を実装（関数単位の複雑度を集約）
  - 複雑度計算エラー時の適切なエラーハンドリング（ResultAsync型）
  - _要件: 2.1, 2.2, 2.5（複雑度計算の基本機能）_

- [ ] 3.2 複数ファイルの並列解析とエラーリカバリー
  - Promise.allを使用した複数ファイルの並列複雑度計算
  - 個別ファイルの解析失敗時は警告ログを出力し、他のファイルは継続処理
  - PR全体の複雑度を最大値（max）で集約
  - すべてのファイルが失敗した場合のエラーハンドリング
  - _要件: 2.1, 2.2, 6.2（並列処理とエラーハンドリング）_

- [ ] 3.3 複雑度計算のタイムアウトと最適化
  - 大規模ファイル（>10,000行）の複雑度計算タイムアウト設定（5秒/ファイル）
  - メモリ使用量の監視と制限（GitHub Actionsランナー制限を考慮）
  - 複雑度計算が無効化されている場合のスキップロジック
  - 非対象拡張子のファイルを効率的にスキップ
  - _要件: 2.4, 2.5（複雑度計算の制御と最適化）_

- [x] 4. ラベル判定ロジックの実装
- [x] 4.1 サイズベースラベル判定の実装
  - PR追加行数に基づくサイズラベル判定ロジック（small/medium/large/xlarge）
  - 設定された閾値を使用した境界値判定
  - 範囲 `[0,100)`, `[100,500)`, `[500,1000)`, `[1000,∞)` の正確な実装
  - 除外パターン適用後の追加行数を使用
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.6（サイズラベル判定）_

- [x] 4.2 複雑度ベースラベル判定の実装
  - PR全体の最大複雑度に基づくラベル判定（medium/high）
  - 設定された閾値（例: medium >= 10, high >= 20）を使用
  - 複雑度が低い場合はラベルなしを返す
  - 複雑度データが未定義（分析失敗）の場合はnullを返す
  - _要件: 2.1, 2.2, 2.3, 2.4（複雑度ラベル判定）_

- [x] 4.3 カテゴリベースラベル判定の実装
  - 変更ファイルパスとminimatchパターンのマッチング
  - 複数カテゴリに該当する場合のすべてのラベル抽出（加法ポリシー）
  - デフォルトカテゴリパターン（components, ci-cd, documentation, tests）の実装
  - カスタムカテゴリパターンの適用
  - ラベル付与順序の安定化（設定定義順）
  - _要件: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7（カテゴリラベル判定）_

- [x] 4.4 リスクベースラベル判定の実装
  - テストファイル有無の検出（`__tests__/`, `*.test.*`パターン）
  - コア機能変更の検出（`src/**`パターン）
  - 設定ファイル変更の検出（`.github/workflows/**`, `package.json`, `tsconfig.json`）
  - テストなし + コア変更 = risk/high のロジック
  - 設定ファイル変更 = risk/medium のロジック
  - ドキュメントのみ変更の場合はラベルなし
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6（リスクラベル判定）_

- [x] 4.5 統合ラベル判定エンジンの実装
  - 4つのディメンション（サイズ、複雑度、カテゴリ、リスク）のラベル判定を統合
  - 各判定結果を集約してLabelDecisionsオブジェクトを生成
  - ラベル判定理由（LabelReasoning）の記録（デバッグ用）
  - 純粋関数として実装（外部依存なし、副作用なし）
  - _要件: 1.1-1.6, 2.1-2.5, 3.1-3.7, 4.1-4.6（全ラベル判定の統合）_

- [x] 5. ラベル適用機能の実装
- [x] 5.1 現在のラベル取得と差分計算
  - GitHub APIから現在のPRラベルを取得
  - 新しいラベル判定結果と現在のラベルを比較
  - 名前空間ポリシー（replace/additive）に基づいて追加・削除すべきラベルを計算
  - サイズラベル（`size/*`）の置換ポリシー実装（既存ラベル削除）
  - カテゴリラベル（`category/*`）の加法ポリシー実装（既存ラベル保持）
  - _要件: 1.5（サイズラベル置換）, 3.6（カテゴリラベル加法）_

- [x] 5.2 ラベルの追加と削除操作
  - バッチAPIを使用した複数ラベルの追加（単一POST呼び出し）
  - 個別APIを使用したラベルの削除（個別DELETE呼び出し）
  - API呼び出し数のカウントと最小化（目標: 50回/実行以内）
  - ラベル不存在時の自動作成（create_missing=trueの場合）
  - _要件: 6.4（ラベル付与操作）_

- [ ] 5.5 ラベル自動作成のデフォルト属性定義
  - 自動作成時のデフォルト色（例: `#0366d6`）と説明文（例: "Set by PR Labeler"）を定義
  - 既存ラベル属性差分の扱い（色/説明の更新ポリシー）を決定
  - 設定で上書き可能な拡張性の検討と実装
  - _要件: 5.6, 6.4（ドキュメント整合と一貫した運用）_

- [x] 5.3 権限チェックとエラーハンドリング
  - 権限不足（403エラー）時のラベル操作スキップ
  - フォークPR対応（書き込み権限なしでも正常動作）
  - レート制限（429エラー）時の指数バックオフリトライ（最大3回）
  - GitHub APIエラー時のエラーメッセージ生成とログ出力
  - _要件: 6.2, 6.5, 6.6（エラーハンドリング）_

- [x] 5.4 冪等性保証の実装
  - 同じPR状態で再実行しても同じラベル状態になることを保証
  - 差分計算により不要なAPI呼び出しを削減
  - ラベル追加・削除の順序制御（削除 → 追加）
  - LabelUpdateオブジェクトの生成（added, removed, skipped, apiCallsを記録）
  - _要件: 9.1（冪等性保証）_

- [x] 6. メインフローの統合と実装
- [x] 6.1 GitHub Actions入力のパースと検証
  - GitHub Actions入力パラメータの読み込み（github_token, fail_on_error等）
  - 既存のinput-mapperとの統合（PR基本情報の取得）
  - 入力パラメータのバリデーションとResult型でのエラー返却
  - PRコンテキストの取得（owner, repo, prNumber, ref）
  - _要件: 6.1（Actions入力パラメータ取得）_

- [x] 6.2 全体フローの実装とエラーハンドリング
  - 設定ファイル読み込み → ファイル分析 → 複雑度計算 → ラベル判定 → ラベル適用の順次実行
  - 各ステップのResult型チェックとエラー時の適切な処理
  - fail_on_error設定に基づくワークフロー失敗制御
  - 複雑度分析失敗時の継続処理（警告ログ出力）
  - try-catchによる予期しないエラーのキャッチとcore.setFailed呼び出し
  - _要件: 6.1-6.8（GitHub Actions統合とエラーハンドリング）_

- [ ] 6.4 dry_runモードの実装
  - Actions入力`dry_run: boolean`を追加し、メインフローに反映
  - dry_run=true の場合、ラベル適用API呼び出しをスキップし、Summary/Outputsのみ生成
  - Summaryにdry_runである旨を明記
  - _要件: 6.6, 6.7（安全な実行と明確なフィードバック）_

- [x] 6.3 既存メトリクス計算機能との統合
  - 既存のanalyzeFiles関数を使用したファイルメトリクス計算
  - 既存のisExcluded関数を使用したファイル除外パターン適用
  - 既存のpattern-matcherとの統合
  - FileMetrics配列からPRMetricsオブジェクトへの変換
  - _要件: 7.1, 7.2, 7.3（既存コアロジックの再利用）_

- [ ] 7. GitHub Actions Summary生成機能の実装
- [ ] 7.1 Markdownレポートの生成
  - ラベル変更セクションの生成（追加・削除・スキップラベル一覧）
  - メトリクスセクションの生成（総追加行数、ファイル数、最大複雑度）
  - 判定理由セクションの生成（各ラベルの付与理由を説明）
  - 設定セクションの生成（使用された閾値とルール）
  - 実行時刻の追加（ISO 8601形式、UTC）
  - ヘルスメトリクスの表示（API呼び出し数、成功率、リトライ回数）
  - _要件: 6.7（Actions Summary出力）_

- [ ] 7.2 GitHub Actions Outputsの設定
  - labels_added出力の設定（JSON配列形式）
  - labels_removed出力の設定（JSON配列形式）
  - complexity_max出力の設定（数値または未定義）
  - その他の有用なメトリクスを出力として設定
  - _要件: 6.4, 6.8（Actions Outputs設定）_

- [ ] 7.4 Summaryスナップショット（Golden）テスト
  - 可変値（時刻、ハッシュ等）をマスクして安定化
  - バリエーション（権限不足、dry_run、docs-only、複雑度失敗）ごとの出力差分を検証
  - スナップショット更新の運用手順を整備
  - _要件: 6.7, 8.4（レポートの品質保証）_

- [ ] 7.5 Outputs定義の最終化とドキュメント化
  - 出力名と型（`labels_added: string[]`, `labels_removed: string[]`, `complexity_max: number | undefined`）をfix
  - READMEとaction.ymlの記述を同期
  - _要件: 6.8（Outputsの一貫性）_

- [ ] 7.3 権限不足時の警告表示
  - 権限不足やフォークPRでラベル操作がスキップされた場合の警告メッセージ
  - Summary-onlyモードの説明（ラベル操作なしでメトリクス表示のみ）
  - 必要な権限（pull-requests: write, issues: write）の明示
  - ヘルスメトリクスの表示（API呼び出し数、成功率、リトライ回数）
  - _要件: 6.5, 6.6（権限不足時の適切なフィードバック）_

- [x] 8. ユニットテストの実装
- [x] 8.1 設定管理機能のテスト
  - YAML正常パースのテスト（有効な設定ファイル）
  - YAML構文エラーのテスト（デフォルト設定へのフォールバック）
  - 型不一致のテスト（バリデーションエラー）
  - 閾値整合性違反のテスト（small >= mediumエラー）
  - 未知キーの警告テスト
  - 部分的な設定のマージテスト
  - _要件: 5.1-5.8, 8.1（設定管理のテスト）_

- [ ] 8.2 複雑度分析機能のテスト
  - 単一ファイルの正常解析テスト
  - 複数ファイルの並列解析テスト
  - 最大複雑度集約のテスト
  - 非対象拡張子スキップのテスト
  - AST解析エラーのハンドリングテスト
  - タイムアウト処理のテスト
  - _要件: 2.1-2.5, 8.5（複雑度分析のテスト）_

- [x] 8.3 ラベル判定ロジックのテスト
  - サイズラベル境界値テスト（99, 100, 499, 500, 999, 1000, 1001行）
  - 複雑度ラベル境界値テスト（9, 10, 19, 20複雑度）
  - カテゴリラベルminimatchパターンテスト（グロブ、否定、複数マッチ）
  - リスクラベルヒューリスティックテスト（テストあり/なし × コア変更あり/なし）
  - 名前空間ポリシーテスト（replace/additive）
  - 純粋関数のプロパティベーステスト（同じ入力 → 同じ出力）
  - _要件: 1.1-1.6, 2.1-2.5, 3.1-3.7, 4.1-4.6, 8.4（ラベル判定のテスト）_

- [x] 8.4 ラベル適用機能のテスト
  - 冪等性保証のテスト（同じ入力で再実行）
  - 差分計算のテスト（add/remove最小化）
  - ラベル作成のテスト（create_missing=true）
  - 権限不足処理のテスト（403エラー）
  - レート制限リトライのテスト（429エラー）
  - GitHub APIモックを使用したテスト
  - _要件: 1.5, 6.2-6.6, 8.8, 9.1（ラベル適用のテスト）_

- [ ] 8.7 エッジケーステスト
  - リネームの扱い（新パス基準でカテゴリ判定されること）
  - バイナリファイル混在（非対象として扱われること）
  - docs-only PR（ラベル判定/適用のスキップが期待通り）
  - 除外パターンにのみ一致する変更（サイズ/カテゴリ集計から除外されること）
  - 極端に大きいPR（処理時間とメモリが許容内、必要に応じてスキップ/タイムアウト）
  - dry_runモード（ラベル適用呼び出しが行われないこと）
  - _要件: 1.6, 3.6, 6.6, 9.2-9.5（安定性と運用性）_

- [ ] 8.5 エラーハンドリングのテスト
  - ConfigurationErrorの処理テスト
  - GitHubAPIErrorの処理テスト（各HTTPステータス）
  - ComplexityAnalysisErrorの処理テスト
  - FileSystemErrorの処理テスト
  - エラーメッセージの品質テスト
  - neverthrowのResult型との統合テスト
  - _要件: 6.2, 6.3, 8.9（エラーハンドリングのテスト）_

- [x] 8.6 テストカバレッジの達成
  - ユニットテスト全体のカバレッジ測定
  - カバレッジ90%以上の達成
  - 未カバー部分の特定と追加テスト作成
  - カバレッジレポートの生成と確認
  - _要件: 8.1, 8.10（テストカバレッジ90%以上）_

- [ ] 9. 統合テストとエンドツーエンド検証
- [ ] 9.1 E2Eラベル付与フローのテスト
  - PR開封 → 設定読み込み → ファイル分析 → 複雑度計算 → ラベル判定 → GitHub API呼び出し → Summary出力の全体フロー
  - GitHub APIモック（Octokit）を使用した統合テスト
  - ファイルシステムモック（fs）を使用した統合テスト
  - 実際のPRシナリオをシミュレート（小規模/大規模、単一/複数カテゴリ）
  - _要件: 全要件（E2E統合）_

- [ ] 9.2 設定フォールバックフローのテスト
  - YAML不正 → エラーログ → デフォルト設定適用 → 正常ラベル付与のフロー
  - GitHub API 404応答のモック
  - デフォルト設定での正常動作の検証
  - 警告ログの出力検証
  - _要件: 5.2, 5.7（設定フォールバック）_

- [ ] 9.3 権限不足フローのテスト
  - GitHub API 403エラー → ラベル操作スキップ → Summary警告出力 → ワークフロー継続のフロー
  - フォークPRシナリオのシミュレート
  - Summary-onlyモードの動作検証
  - ワークフローが失敗しないことの確認
  - _要件: 6.5, 6.6（権限不足時の継続処理）_

- [ ] 9.4 複雑度分析失敗フローのテスト
  - ESLint complexityエラー → 警告ログ → 複雑度ラベルなしで継続のフロー
  - ESLint complexityモック（throw Error）
  - 他の機能（サイズ、カテゴリ、リスクラベル）が正常動作することの確認
  - 警告ログの内容検証
  - _要件: 2.5, 6.6（複雑度分析失敗時の継続）_

- [ ] 9.5 冪等性検証テスト
  - 同じPR状態で2回実行 → 同じラベル状態（API呼び出し最小化）のテスト
  - 1回目と2回目のAPI呼び出し数の比較
  - ラベルの最終状態が一致することの確認
  - 不要なラベル追加・削除がないことの確認
  - _要件: 9.1（冪等性保証）_

- [x] 10. 品質保証と最終検証
- [x] 10.1 型安全性の検証
  - TypeScript strict modeの全設定遵守の確認
  - any型の排除（ESLintルールでチェック）
  - 型アサーション（as）の最小化とコメント説明の確認
  - noUncheckedIndexedAccessへの準拠確認
  - neverthrowのResult型の一貫使用確認
  - _要件: 7.4, 7.5, 7.6, 7.7（型安全性）_

- [x] 10.2 コード品質チェック
  - ESLint実行とすべてのルール違反の解消
  - Prettier実行とコードフォーマットの統一
  - TypeScript型チェック（tsc --noEmit）の成功
  - 未使用変数・未使用インポートの削除
  - コードレビュー基準（関数複雑度、ファイル行数）の遵守
  - _要件: 8.10（品質保証）_

- [x] 10.3 ビルドと統合の検証
  - pnpm buildの成功確認
  - dist/index.jsの生成確認
  - バンドルサイズの確認（適切な範囲内）
  - ソースマップの生成確認
  - ライセンスファイルの生成確認
  - _要件: 8.10（ビルド成功）_

- [x] 10.4 すべてのチェックの統合実行
  - `pnpm lint && pnpm type-check && pnpm test && pnpm build`の成功
  - CIパイプラインでのローカル実行シミュレート
  - すべてのテストが成功することの確認
  - カバレッジ90%以上の達成確認
  - ビルド成果物の検証
  - _要件: 8.10（すべてのチェック成功）_

- [x] 10.5 ドキュメントとaction.ymlの更新
  - action.ymlへの新規入力パラメータ追加（必要に応じて）
  - action.ymlへの新規出力パラメータ追加
  - READMEへの機能説明追加（サイズ、複雑度、リスク、カテゴリラベル）
  - 使用例の追加（.github/pr-labeler.yml設定例）
  - ワークフロー例の追加（permissions, concurrency, フォークPR時の注意点, dry_runサンプル）
  - CHANGELOGへのエントリ追加
  - _要件: すべて（ドキュメント）_

## タスク完了基準

各タスクは以下の基準を満たした時点で完了とみなします：

1. **機能要件**: 該当する要件の受け入れ基準（EARS形式）をすべて満たす
2. **コード品質**: ESLint、Prettier、TypeScript型チェックがすべて成功
3. **テスト**: 該当機能のユニットテストが存在し、成功する
4. **型安全性**: any型を使用せず、Result型で適切にエラーハンドリング
5. **ドキュメント**: 複雑なロジックにコメント説明がある
6. **統合**: 他のコンポーネントと適切に連携し、E2Eフローで動作する

## 実装の優先順位

タスクは上記の順序で実装することを推奨しますが、以下の優先順位も考慮してください：

1. **高優先度**: 1（基盤）、2（設定）、4（ラベル判定）、5（ラベル適用）、6（統合）
2. **中優先度**: 3（複雑度分析）、7（Summary生成）、8（ユニットテスト）
3. **低優先度**: 9（統合テスト）、10（品質保証）

複雑度分析（タスク3）はオプショナル機能として後回しにすることも可能です。その場合、タスク4.2（複雑度ラベル判定）はスキップまたは常にnullを返す実装にします。

補足（優先度の微調整）

- ドキュメント整備（10.5: action.yml/README/ワークフロー例）は、5（適用）～6（統合）と並行の高優先度として扱う。
