# 実装計画

## 概要

PR Metrics Actionの実装タスクリストです。各タスクは1-3時間で完了可能なサイズに分割されています。

---

## タスク一覧

- [x] 1. プロジェクト基盤とビルド環境の構築
- [x] 1.1 TypeScriptプロジェクトの初期設定
  - package.jsonの依存関係インストール
  - tsconfig.jsonの作成（strict mode有効）
  - src/index.tsのエントリーポイント作成
  - @vercel/nccビルド設定の確認
  - _Requirements: 全要件の基盤_

- [x] 1.2 開発ツールとCI環境の設定
  - ESLint設定ファイルの作成（v9構成）
  - Prettier設定ファイルの作成
  - Vitestの設定とテスト構造の準備
  - .gitignoreとエディタ設定の追加
  - GitHub Actionsワークフロー（.github/workflows/test.yml）の作成
  - _Requirements: 7.1, 7.4_

- [x] 2. エラーハンドリング基盤の実装
- [x] 2.1 neverthrowベースの型定義とユーティリティ
  - AppError統合型の定義（9種類のエラー型）
  - Result型の基本ユーティリティ関数作成
  - エラー変換・マッピング関数の実装
  - Railway-Orientedプログラミングパターンのヘルパー関数
  - _Requirements: 6.7, 6.8_

- [x] 2.2 GitHub Actions入出力インターフェース
  - アクション入力パラメータの取得処理
  - 出力変数の設定機能
  - GitHub Token取得と環境変数フォールバック
  - core.info/debug/warning/errorログラッパー
  - _Requirements: 7.1, 7.2_

- [x] 3. 設定管理とパラメータ処理
- [x] 3.1 入力マッピングと検証機能
  - snake_caseからcamelCaseへの変換処理
  - boolean値のパース（true/1/yes/on対応）
  - サイズ文字列のバイト変換（100KB→102400）
  - 除外パターンの配列パース（カンマ・改行区切り）
  - _Requirements: 1.6, 1.8_

- [x] 3.2 サイズ閾値と設定検証
  - size_label_thresholdsのJSON解析
  - コメントモード（auto/always/never）の検証
  - 必須パラメータの存在確認
  - デフォルト値の適用と設定オブジェクト生成
  - _Requirements: 3.7_

- [x] 4. ファイル分析エンジンの実装
- [x] 4.1 PR差分取得とファイルリスト生成
  - ローカルgitコマンドでの差分取得（優先、`git diff --numstat --diff-filter=ACMR`使用）
  - GitHub API経由での差分取得（フォールバック）
  - ページネーション処理（100ファイル/ページ）
  - 変更種別フィルタリング（removed除外、ACMR: added/copied/modified/renamed）
  - _Requirements: 1.1, 1.10, 1.11, 2.1, 2.2_

- [x] 4.2 除外パターンマッチング
  - デフォルト除外パターン（40種類以上）の定義
  - minimatchによるパターンマッチング実装
  - パス正規化処理（OS非依存）
  - 追加除外パターンの統合
  - _Requirements: 1.7, 1.8_

- [x] 4.3 ファイルメトリクス計測
  - ファイルサイズ取得（fs.stat優先→git ls-tree→API）
  - 行数カウント処理（wc -lまたはNode.js実装）
  - バイナリファイル検出とスキップ処理（`istextorbinary`ライブラリまたは拡張子判定）
  - メトリクス集計（総追加行数、ファイル数）
  - 大ファイルの早期打ち切り（行数カウント最適化）
  - _Requirements: 1.2, 1.3, 1.9, 2.1_

- [x] 4.4 違反検出と結果生成
  - ファイルサイズ制限チェック
  - ファイル行数制限チェック
  - PR全体の追加行数制限チェック
  - ファイル数制限チェックと早期打ち切り
  - 違反情報の構造化（ViolationDetail型）
  - _Requirements: 1.4, 1.5, 2.3, 2.4, 2.5, 2.6_

- [x] 5. GitHub統合機能の実装
- [x] 5.1 ラベル管理システム
  - 現在のラベル取得処理
  - ラベル追加・削除の冪等性実装
  - サイズラベル（S/M/L/XL）の判定ロジック
  - 詳細ラベル（auto/large-files等）の管理
  - 古いサイズラベルの自動削除
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.8_

- [x] 5.2 コメント投稿システム
  - 既存コメントの検索（署名ベース）
  - 違反レポートのMarkdown生成
  - 表形式での情報表示
  - コメント投稿・更新処理
  - 成功メッセージとラベル削除通知
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7_

- [x] 5.3 Draft PR処理とステータス判定
  - PRのDraftステータス確認
  - スキップ処理とログ出力
  - ready_for_reviewイベント対応
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 6. メインオーケストレーション
- [x] 6.1 アクション全体フローの統合
  - PR情報とコンテキストの取得
  - 設定パラメータの読み込みと検証
  - ファイル分析の実行と結果取得
  - ラベル・コメント処理の条件分岐
  - _Requirements: 全要件の統合_

- [x] 6.2 出力と終了処理
  - Action出力変数の設定（8種類）
  - GitHub Actions Summaryへの結果出力
  - fail_on_violationポリシーの実装
  - エラー時のcore.setFailed呼び出し
  - 冪等性の保証と再実行対応
  - _Requirements: 3.9, 6.1, 6.2, 6.3, 6.4, 6.5, 7.3, 7.5_

- [x] 7. テストとビルド準備
- [x] 7.1 ユニットテストの実装
  - サイズパーサーのテストケース
  - パターンマッチャーのテストケース
  - 設定検証ロジックのテスト
  - エラーハンドリングのテスト
  - モックを使用したGitHub API呼び出しテスト
  - _Requirements: 品質保証全般_

- [x] 7.2 統合テストとビルド
  - エンドツーエンドの動作確認テスト（5シナリオ実装、3/5ローカル成功）
  - nccによる単一ファイルビルド生成
  - dist/index.jsの動作確認
  - CIでのテスト自動実行設定（quality.ymlに追加）
  - _Requirements: 7.4_

- [x] 7.3 自己テスト用ワークフローの拡張
  - .github/workflows/quality.ymlに統合テストジョブ追加
  - 複数Node.jsバージョン（20, 22）でのテスト実行
  - dist/ビルド整合性検証
  - 統合テスト結果をquality-gateに統合
  - _Requirements: 品質保証全般_

- [x] 8. ドキュメント作成
- [x] 8.1 README.mdと使用例
  - プロジェクト概要とバッジ表示
  - インストール手順とクイックスタート
  - 入力パラメータ・出力変数の詳細表
  - 5つ以上の使用例（基本、カスタム、Draft PR等）
  - トラブルシューティングガイド
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

- [ ] 8.2 権限とフォークPRドキュメント作成
  - 最小権限スコープの文書化（pull-requests:write, issues:write）
  - フォークPRでの制約事項と回避策
  - `pull_request_target`イベント使用時のセキュリティ警告
  - 権限不足時の挙動説明（分析は継続、ラベル・コメントはスキップ）
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [ ] 8.3 使用例集作成（examples/ディレクトリ）
  - 標準的な使用例（examples/basic.yml）
  - 厳格モード例（examples/strict.yml - fail_on_violation有効）
  - コメント抑制例（examples/no-comment.yml）
  - Draft PRスキップ例（examples/draft-skip.yml）
  - フォークPR対応例（examples/fork-pr.yml）
  - _Requirements: 8.5_

---

## 実装順序と依存関係

1. **基盤構築（タスク1）**: 最初に実行、すべての後続タスクの前提
2. **エラー処理（タスク2）**: タスク3-6で使用するため早期実装
3. **設定管理（タスク3）**: タスク4-6の入力として必要
4. **分析エンジン（タスク4）**: コア機能、タスク5-6の前提
5. **GitHub統合（タスク5）**: タスク4の結果を使用
6. **統合（タスク6）**: すべての機能を結合
7. **テスト（タスク7）**: 各機能実装と並行して作成
8. **ドキュメント（タスク8）**: 実装完了後に最終化

## 推定作業時間

- **総作業時間**: 約40-50時間
- **タスク1-2**: 基盤構築 8時間
- **タスク3-4**: コア機能 16時間
- **タスク5-6**: 統合機能 12時間
- **タスク7-8**: テスト・ドキュメント 8時間

## 次のステップ

タスク承認後、以下のコマンドで実装を開始：

```bash
/kiro:spec-impl pr-labeler     # 全タスク実行
/kiro:spec-impl pr-labeler 1   # タスク1から開始
```
